<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <title>Admin | Salary Tracker Dashboard</title>
  <link rel="stylesheet" th:href="@{/css/output.css}">
  <link href="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.1/css/all.min.css" integrity="sha512-5Hs3dF2AEPkpNAR7UiOHba+lRSJNeM2ECkwxUIxC1Q/FLycGTbNapWXB4tP889k5T5Ju8fs4b1P5z/iB4nMfSQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.js"></script>
  <script>
    function confirmDelete(form) {
        const userConfirmation = confirm("Are you sure you want to delete this user?");
        if (userConfirmation) {
            form.submit();  // Submit the form if the user clicks "Yes"
        } else {
            return false;  // Prevent the form submission if the user clicks "No"
        }
    }
  </script>
</head>

<style>
    #deleteModal {
        background-color: rgba(31, 41, 55, 0.6); 
    }
</style>

<body class="bg-gray-100 dark:bg-gray-900">

<main class="h-screen w-full flex flex-col">
    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <section class="bg-blue-50 dark:bg-gray-900 flex-grow h-1/2 w-full">
        <div class="py-8 px-4 mx-auto max-w-screen-xl lg:py-16 grid lg:grid-cols-2 gap-8 lg:gap-16">
            <div class="flex flex-col justify-center">
                <h1 class="mb-4 text-4xl font-extrabold tracking-tight leading-none text-gray-900 md:text-5xl lg:text-6xl dark:text-white">
                    Welcome, <span th:text="${name}">Admin</span>
                </h1>

                <h1 class="mb-4 text-4xl font-extrabold tracking-tight leading-none text-gray-900 md:text-5xl lg:text-6xl dark:text-white">Admin Dashboard</h1>
                <p class="mb-6 text-lg font-normal text-gray-500 lg:text-xl dark:text-gray-400">
                    Utility To Analyse The Salary Trend.
                </p>
            </div>
        </div>
    </section>

    <!-- Excel Upload & Sample Download Section -->
    <section class="px-4 h-full py-8">
        <div class="max-w-screen-xl mx-auto space-y-8">
            <h2 class="text-3xl font-bold text-gray-900 dark:text-white">Trend</h2>

            <!-- Excel Upload Form -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded shadow mb-8">
                <h3 class="text-lg font-semibold mb-2 text-gray-900 dark:text-white">Upload Users via Excel</h3>
                <form th:action="@{/api/salaries/upload}" method="post" enctype="multipart/form-data" class="flex flex-col md:flex-row items-center gap-4">
                    <input type="text" name="employeeId" placeholder="Employee ID" required class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 dark:text-gray-400 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400" />
                    <input type="file" name="file" accept=".xlsx,.xls" required class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 dark:text-gray-400 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400" />
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Upload</button>
                </form>
                <div class="mt-2">
                    <a th:href="@{/admin/SampleExcel.xlsx}" class="text-blue-600 hover:underline">Download Sample Excel</a>
                </div>
                <div class="mt-2">
                    <div th:if="${uploadMessage}" th:text="${uploadMessage}" class="text-green-600 font-semibold"></div>
                    <div th:if="${uploadError}" th:text="${uploadError}" class="text-red-600 font-semibold"></div>
                </div>
            </div>


            <!--     Only show if uploadMessage is present -->
            <div th:if="${uploadMessage}" class="bg-white dark:bg-gray-800 p-6 rounded shadow mb-8">
                <h3 class="text-lg font-semibold mb-2 text-gray-900 dark:text-white">Salary Trend (Bar Chart)</h3>
                <canvas id="salaryTrendChart" height="100"></canvas>
            </div>

             <div class="overflow-hidden bg-white shadow sm:rounded-lg dark:bg-gray-800">
                <div class="px-4 py-5 sm:px-6">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">All Users</h3>
                    </div>
                </div>
                <div class="border-t border-gray-200 dark:border-gray-700">
                    <table class="w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-800">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">First Name</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Name</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone Number</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
                            <!-- Thymeleaf iteration for user list -->
                            <tr th:each="user : ${users}">
                                <td class="px-6 py-4 text-sm font-medium text-gray-900 dark:text-white" th:text="${user.firstName}"></td>
                                <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400" th:text="${user.lastName}"></td>
                                <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400" th:text="${user.email}"></td>
                                <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400" th:text="${user.phNumber}"></td>
                                <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400" th:text="${user.role}"></td>
                                <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">
                                    <!-- Edit Button -->
                                    <a href="#" th:href="@{/admin/users/{id}/edit(id=${user.id})}" class="text-blue-600 hover:text-blue-800">Edit</a>
                                    <!-- Delete Form -->
                                    <form th:action="@{/admin/users/{id}/delete(id=${user.id})}" method="post" style="display:inline;" onsubmit="return confirmDelete(this)">
                                        <!-- CSRF Token -->
                                        <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}"/>
                                        <button type="submit" class="ml-4 text-red-600 hover:text-red-800">Delete</button>
                                    </form>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
           
        </div>
    </section>

    <!-- Footer Section -->
    <footer th:replace="~{fragments/footer :: footer}"></footer>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script th:src="@{/js/script.js}"></script>
<script th:inline="javascript">
/*<![CDATA[*/
// Get salary trend data from the model attribute
const salaryTrendData = /*[[${salaryTrendData}]]*/ [];
const ctx = document.getElementById('salaryTrendChart').getContext('2d');
const chart = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: salaryTrendData.map(item => item.year),
        datasets: [{
            label: 'CTC (in USD)',
            data: salaryTrendData.map(item => item.ctc),
            backgroundColor: [
                'rgba(54, 162, 235, 0.7)',
                'rgba(75, 192, 192, 0.7)',
                'rgba(255, 206, 86, 0.7)',
                'rgba(255, 99, 132, 0.7)'
            ],
            borderColor: [
                'rgba(54, 162, 235, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(255, 99, 132, 1)'
            ],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: false },
            title: {
                display: true,
                text: 'Salary Trend by Year'
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                title: { display: true, text: 'CTC (in USD)' }
            },
            x: {
                title: { display: true, text: 'Year' }
            }
        }
    }
});
/*]]>*/
</script>

</body>
</html>